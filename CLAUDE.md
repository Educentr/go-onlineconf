# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is `go-onlineconf`, a Go package for reading configuration files generated by [onlineconf-updater](https://github.com/onlineconf/onlineconf#onlineconf-updater). It opens indexed CDB files, maps them into memory via mmap, and automatically reopens them when onlineconf-updater modifies the files.

The project consists of two components:

1. **Runtime library** (`pkg/onlineconf`) - Core package for reading configuration from CDB files with type-safe accessors, file watching, subscription-based change notifications, and clone/release for request-scoped configuration snapshots
2. **CLI tool** (`cmd/cli`) - Command-line utility for generating CDB files from YAML and retrieving configuration values

## Key Commands

### Testing

```bash
make test                        # Run all tests with coverage (30s timeout, parallel=10)
make race                        # Run tests with race detector
make cover                       # Generate HTML coverage report and open in browser
make txt-coverage                # Print total coverage percentage
TEST_TIMEOUT=60s make test       # Run tests with custom timeout
```

Run a single test:
```bash
go test ./pkg/onlineconf/... -v -run TestName
```

### Code Quality

```bash
make lint                # Run golangci-lint on changes from origin/main
make full-lint           # Run golangci-lint on entire codebase
make lint-fix            # Run linter with auto-fix
make install-lint        # Force install golangci-lint v1.59.1
```

### Development Tools

```bash
make bin/mockgen          # Install mockgen v1.6.0
make pre-commit-hook      # Install git pre-commit hook (runs lint)
make pre-push-hook        # Install git pre-push hook (runs cover)
```

### CLI Tool

```bash
# Generate CDB from YAML
go run ./cmd/cli -command generate -yaml ./configs/onlineconf.yml -dir /path/to/cdb -module TREE

# Read a config value
go run ./cmd/cli -command get -config-name "/my/param" -dir /path/to/cdb -module TREE
```

## CI/CD

GitHub Actions workflow (`.github/workflows/makefile.yml`) runs on push/PR to main:
- **test** job: `make test`
- **lint** job: `make lint` (with full git history for `--new-from-rev`)

## Architecture

### Core Types and Their Relationships

**OnlineconfInstance** (`pkg/onlineconf/const.go`, `pkg/onlineconf/onlineconf.go`) - Central instance managing a set of named modules. Handles module lifecycle, mmap reference counting, watcher integration, and clone/release semantics. Instances can be readonly (cloned) - readonly instances cannot register modules, start watchers, or modify refcounts.

**Module** (`pkg/onlineconf/const.go`, `pkg/onlineconf/module.go`) - Represents a single named CDB file. Provides typed getters (String, Int, Bool, Duration, Strings, Struct), internal result caching with `reflect.Value`, and subscription-based change detection on Reopen. On Reopen, subscribed paths are compared byte-by-byte (`bytes.Equal`) between old and new CDB; callbacks fire only when values actually differ and at most once per subscription per reopen. Modules also support readonly mode.

**OnlineconfWatcher** (`pkg/onlineconf/watcher.go`) - Wraps fsnotify to watch the config directory. On `fsnotify.Create` events (onlineconf-updater atomically replaces files), triggers module reopen with new mmap and old mmap refcount decrement.

**Interfaces** (`pkg/onlineconfInterface/onlineconf.go`) - Defines `Instance`, `Module`, `Logger`, `Option`, and `SubscriptionCallback` interfaces. All public APIs return interfaces, not concrete types.

### Two Usage Patterns

1. **Context-based** (`pkg/onlineconf/context.go`) - `Initialize()` creates an instance and stores it in `context.Context`. All package-level functions (`GetString`, `GetInt`, etc.) extract the instance from context. Supports `Clone`/`Release` for per-request snapshots.

2. **Instance-based** (`pkg/onlineconf/onlineconf.go`) - `Create()` returns an instance directly. Caller manages the lifecycle.

### Tree Functions (`pkg/onlineconf/tree.go`)

Convenience wrappers that delegate to the default "TREE" module. Both package-level (context-based) and instance methods are provided for every data type.

### Development Utilities (`pkg/onlineconf_dev/`)

- `GenerateCDB()` / `GenerateCDBFromYaml()` - Create CDB files from `map[string]interface{}` or YAML files
- `Encode()` - Encodes values into CDB format (prefixes: `'s'` for strings, `'j'` for JSON)
- Used by tests and CLI tool to generate test CDB fixtures

### Mmap Reference Counting

The instance tracks all mmap'd files by their pointer address (`fmt.Sprintf("%p", ...)`) in `mmappedFiles` map. On clone, refcount is incremented; on release or file reopen, refcount is decremented. When refcount reaches 0, the mmap file is closed. Only the main (non-readonly) instance can modify refcounts.

### CDB Data Format

Values in CDB are stored with a 1-byte format prefix:
- `'s'` - string value (remainder is UTF-8 string)
- `'j'` - JSON value (remainder is JSON bytes, used for arrays and structs)
- `0` (zero-length data) - parameter does not exist

### Environment Variable Initialization

When `ONLINECONFIG_FROM_ENV` is set, `Initialize()` scans environment variables prefixed with `OC_` and generates a CDB file from them. The variable name is converted to a config path: `OC_foo__bar__baz` becomes `/foo/bar/baz`.

## Minimum Requirements

- **Go 1.21.5+** (enforced by `scripts/goversioncheck.sh`)
- **golangci-lint 1.59.1** (auto-installed by make targets)

## Linting Configuration

Configured in `.golangci.yaml`:
- 23 linters enabled (strict mode with `disable-all: true`)
- Line length limit: 120 characters
- `gocritic` style checks disabled
- `revive` ignores generated headers
